<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=EB+Garamond" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.10.2/p5.js"></script>
  <script src="lib/ml5.min.js"></script>
  <script src="lib/p5.speech.js"></script>
  <script src="lib/tf.min.js"></script>
  <script src="lib/teachablemachine-pose.min.js"></script>
  <script src="lib/poseTrain.js"></script>  
  <style>
    body {
      font-family: sans-serif;
      background-color: white;
      max-width: 30em;
    }

    select,
    button {
      font-size: 100%;
      max-width: 15em;
    }

    #title {
      font-size: 120%;
      font-weight: bold;
    }

    #about>p {
      margin: 0.5em 0;
    }

    .section {
      border: 1px solid #ccc;
      margin: 0.5em 0;
      padding: 0.5em;
      border-radius: 0.5em;
      font-family: 'EB Garamond', serif;
      background-color: rgb(245, 245, 245);
    }
    #sketch-div{
      position: absolute;;
      width: 500px;
      height: 100%;
    }
	.myButton {
		background-color:#f9f9f9;
		border-radius:13px;
		border:1px solid #dcdcdc;
		display:inline-block;
		cursor:pointer;
		color:#666666;
		font-family:Arial;
		font-size:15px;
		margin-left:10px;
		padding:10px 27px;
		text-decoration:none;
		text-shadow:0px 1px 0px #ffffff;
	}
	.myButton:hover {
		background-color:#e9e9e9;
	}
	.myButton:active {
		position:relative;
		top:1px;
	}

    #poetryContent{
      margin-left: 600px;
      height: 100%;
      width: 100%;
    }
    #poem {
      max-height: 15em;
      overflow: scroll;
    }

  </style>
  <script>
  	let video;
  	var allSeeds = new Array();
  	var currentPoetryString = "";
  	
  	// ml5 + posenet
  	let poseNet;
  	let pose;
  	let brain;
	let skeleton;

  	// speech recognition
  	var speechRec = new p5.SpeechRec('en-US',gotSpeech);
  	speechRec.continuous = true;
  	speechRec.interimResults = true;
  	// text to speech
  	speechVoice = new p5.Speech();
  	speechVoice.setRate(0.8);
  	let isSpeak = false;

  	function setup(){
  		var canvas = createCanvas(500,500);
  		canvas.parent('sketch-div');
  		video = createCapture(VIDEO);
  		video.hide();
  		background(0);

  		// speech
  		speechRec.start();
  		speechRec.onEnd = speechRecEnd;
  		//speechVoice.onPause = speakPause;

  		// add stop speak button
  		speakStopbutton = createButton('Stop');
  		speakStopbutton.position(430, 500);
  		speakStopbutton.mousePressed(stopSpeak);

  		// add posenet
  		poseNet = ml5.poseNet(video, modelLoaded);
  		poseNet.on('pose', gotPoses);
  		let options = {
  			inputs: 34,
  			outputs: 7,
  			task: 'classification',
  			debug: true
  		}

  		brain = ml5.neuralNetwork(options);
  		const modelInfor = {
  			model: 'model/model.json',
    		metadata: 'model/model_meta.json',
    		weights: 'model/model.weights.bin',
  		}
  		brain.load(modelInfor, brainLoaded);

  	}
  	function draw(){
  		background(0,20);
  		fill(255);
  		image(video, width*0.25, height*0.25, width*0.5, (width * 0.5) * video.height / video.width);
  		ellipse(mouseX, mouseY,20,20);
  	}

  	// begin speak
  	function gotSpeech(){
  		var resultWord = speechRec.resultString.split(' ').pop();
	  	if(allSeeds.length > 0){
	  		if (allSeeds.indexOf(resultWord) >-1) { // change seed of poetry base on speech
	  			poseChangeRegenerate(resultWord);
	  		}else if(resultWord =='speech' && isSpeak == false){
	  			//console.log(currentPoetryString);
	  			isSpeak = true;
	  			speechVoice.speak(currentPoetryString);
	  			speechVoice.onEnd = speakEnd;
	  		}else if(resultWord =='stop'){
	  			speechVoice.stop()
	  		}
	  	}
	  	console.log(speechRec.resultString.split(' ').pop());
	}

	// speak end
	function speakEnd(){
		isSpeak = false;
		console.log("speechEnd================")
	}
	// speechRech end
	function speechRecEnd(){
		console.log("speechRecEnd===============")
		speechRec.start();
	}

	// stop speak 
	function stopSpeak(){
		speechVoice.pause();
	}

	function modelLoaded() {
		console.log("model load ==========");
	}

	function gotPoses(poses) {
		if(poses.length > 0){
			pose = poses[0].pose;
			skeleton = poses[0].skeleton;
		}
	}

	function brainLoaded() {
		console.log("brain load ==========");
		classifyPose();
	}

	function classifyPose() {

		if(pose) {
			let inputs = [];
			for (let i = 0; i < pose.keypoints.length; i++) {
				let x = pose.keypoints[i].position.x;
				let y = pose.keypoints[i].position.y;
				inputs.push(x);
				inputs.push(y);
			}
			brain.classify(inputs, gotResult);
		}else {
			setTimeout(classifyPose, 100);
		}
	}

	function gotResult(error, results) {
		if(results[0].confidence > 0.75){
			// pose result
			let poseResultStr = results[0].label.toUpperCase();
			console.log("brain result ==========");
			console.log(poseResultStr);
		}
		classifyPose();
	}

  </script>
</head>

<body>
  <p>
  AI X Dance X Poetry
  </p>
  <p>
  	Speech control / WebCam Movement control
  </p>
  <div id="main">
  <div id="sketch-div"></div>
  <div id="poetryContent">
  <select id="poems"></select> 
  <button class="myButton" onclick="randomSelect(selectPoems); update();">random</button>
  <div id="poem" class="section">Loading...</div>

  <select id="seeds"></select> 
  <button class="myButton" onclick="randomSelect(selectSeeds); update();">random</button>
  <button class="myButton" onclick="regenerate()">generate</button>
  <p id="generated" class="section">Loading...</p>

  <p id='jing' style='display:none'>
    Jing 
  </p>
</div>
</div>
  <script>
    let index = 0;

    let selectPoems = document.querySelector('#poems');
    let selectSeeds = document.querySelector('#seeds');
    let poemElt = document.querySelector("#poem");
    let generatedElt = document.querySelector("#generated");

    function convertNewlines(text) {
      return text.split('\n').join('<br/>').split('<|endoftext|>')[0];
    }

    function update() {
      let key = selectPoems.value;
      let poem = poems[key];
      poemElt.innerHTML = poem.poem.join('<br/>');
      let seed = selectSeeds.value;
      generatedElt.innerHTML = convertNewlines(generated[seed][key][index]) + '...';
      currentPoetryString = generated[seed][key][index];


    }

    function randomSelect(elt) {
      let n = elt.options.length;
      let i = Math.floor(Math.random() * n);
      elt.value = elt.options[i].value;
      regenerate();
    }

    // for python change poetry
    function poseChangeRegenerate(predicttype) {
      selectSeeds.value = predicttype;
      selectSeeds.onchange = update;
      regenerate()
    }

    // for python change period time
    function poseOverTimeRegenerate() {
      randomSelect(selectPoems); 
      update();
    }

    function regenerate() {
      index = (index + 1) % 10;
      update();
    }

    Promise.all([
      fetch('poems.json').then(e => e.json()),
      fetch('generated.json').then(e => e.json())
    ])
      .then(files => {
        poems = files[0];
        generated = files[1];

        let sortable = [];
        for (key in poems) {
          let poem = poems[key];
          sortable.push([
            poem['author'] + ' > ' + poem['title'],
            key
          ])
        }
        sortable.sort(function (a, b) {
          return a[0].toLowerCase().localeCompare(b[0].toLowerCase());
        });
        sortable.forEach(item => {
          let opt = document.createElement("option");
          opt.text = item[0];
          opt.value = item[1];
          selectPoems.add(opt);
        })

        for (key in generated) {
          let opt = document.createElement("option");
          opt.text = key;
          opt.value = key;
          allSeeds.push(key);
          selectSeeds.add(opt);
        }
        randomSelect(selectPoems);
        randomSelect(selectSeeds);

        selectSeeds.onchange = update;
        selectPoems.onchange = update;
        update();
      })
  </script>
</body>

</html>